import e from"./context.js";import t from"./grammar.js";import"./utils-be932c53.js";import"./template.js";import"./utils/verbose-regexp.js";class r{constructor(){this.elements=[]}_fire(e,t,r={},a={}){r.highlighter=this;let s=new CustomEvent(`daub-${e}`,{bubbles:!0,cancelable:!0,...a,detail:r});return t.dispatchEvent(s),s}_updateElement(e,t,r){let a=e.ownerDocument.createRange().createContextualFragment(t),s={element:e,language:r,fragment:a},i=this._fire("will-highlight",e,s);i.defaultPrevented||(i.detail.fragment&&(a=i.detail.fragment),e.innerHTML="",e.appendChild(a))}addElement(e){this.elements.indexOf(e)>-1||this.elements.push(e)}}class a extends r{constructor(e,t={}){if(super(),this.worker=e,!(this.worker instanceof Worker))throw new TypeError('Invalid "worker" option.');this._setupWorker(),this.uid=0,this._callbacks={},this.options={...a.DEFAULT_OPTIONS,...t}}_getLanguage(e){return e.getAttribute("data-language")||e.className}_getSelector(){let e=this.options.selector;return"string"==typeof e&&(e=[e]),e.map((e=>`${e}:not([data-daub-highlighted])`)).join(", ")}_scan(e){let t=this._getSelector(),r=Array.from(e.querySelectorAll(t));if(!r||!r.length)return Promise.resolve([]);r.length;let a=r.map((e=>{let t;e.hasAttribute("data-daub-uid")?t=e.getAttribute("data-daub-uid"):(t=this.uid,e.setAttribute("data-daub-uid",this.uid++));let r=e.innerHTML,a=this._getLanguage(e);return this.parse(r,a,t).then((([e,t])=>(this._updateElement(t,e,a),t.setAttribute("data-daub-highlighted","true"),this._fire("highlighted",t,{element:t,language:a},{cancelable:!1}),t)))}));return Promise.all(a)}_handleMessage(e){let t,{id:r,source:a}=e.data;for(let e of this.elements)if(t=e.querySelector(`[data-daub-uid="${r}"]`),t)break;let s=this._callbacks[r];delete this._callbacks[r],s&&s([a,t])}_setupWorker(){this.worker.onmessage=e=>this._handleMessage(e)}parse(e,t=null,r=null){if(!t)throw new Error("Must specify a language!");return r||(r=Math.random().toString(16).slice(2)),new Promise(((a,s)=>{this._callbacks[r]=a,this.worker.postMessage({type:"parse",text:e,language:t,id:r})}))}highlight(){let e=this.elements.map((e=>this._scan(e)));return Promise.all(e).then((e=>e.flat()))}}a.DEFAULT_OPTIONS={selector:["code[data-language]","code[class]"]};class s extends r{constructor(e={}){super(),this.grammars=[],this._grammarTable={},this.options={...s.DEFAULT_OPTIONS,...e}}_selectorsForGrammar(e){return e.names.map((e=>{let t=this.options.customSelector(e,this.options);return"string"==typeof t&&(t=[t]),t.map((e=>`${e}:not([data-daub-highlighted])`)).join(", ")})).join(", ")}_scan(t){this.grammars.forEach((r=>{let a=this._selectorsForGrammar(r),s=t.querySelectorAll(a);s&&s.length&&Array.from(s).forEach((t=>{if(t.hasAttribute("data-daub-highlighted"))return;let a=new e({highlighter:this}),s=t.innerHTML;r.options.encode&&(s=s.replace(/</g,"&lt;"));let i=this.parse(s,r,a);this._updateElement(t,i,r),t.setAttribute("data-daub-highlighted","true");let l={element:t,grammar:r};this._fire("highlighted",t,l,{cancelable:!1})}))}))}highlight(){this.elements.forEach((e=>this._scan(e)))}_fire(e,t,r,a={}){Object.assign(r,{highlighter:this});let s=Object.assign({bubbles:!0,cancelable:!0},a,{detail:r}),i=new CustomEvent(`daub-${e}`,s);return t.dispatchEvent(i),i}addElement(e){this.elements.indexOf(e)>-1||this.elements.push(e)}addGrammar(e){if("string"==typeof e&&(e=t.find(e)),null===e||!(e instanceof t))throw new TypeError('Invalid "grammar" argument.');if(!e.name)throw new Error("Can't register a grammar without a name.'");this.grammars.indexOf(e)>-1||(this.grammars.push(e),e.names.forEach((t=>this._grammarTable[t]=e)))}parse(t,r=null,a=null){if("string"==typeof r){if(!(r=this._grammarTable[r]))return t}else if(!r)throw new Error("Must specify a grammar!");return a||(a=new e({highlighter:this})),r.parse(t,a)}}s.DEFAULT_OPTIONS={classPrefix:"",customSelector:(e,t)=>[`code.${t.classPrefix}${e}`,`code[data-language="${e}"]`]};export{a as AsyncHighlighter,s as default};
